---
typora-root-url: .
---

## Transform 的实现

由于与正交DCT变换相比，HEVC矩阵按$2^{6+M/2}$进行缩放，并且为了通过正向和反向二维变换保持残差块的范数，需要应用额外的缩放因子——$S_{T1}$， $S_{T2}$, $S_{IT1}$, $S_{IT2}$，如图6.3所示。注意，图6.3基本上是图6.1中变换和量化的定点实现。

虽然HEVC标准规定了逆变换的比例因子(即$S_{IT1}$, $S_{IT2}$)，但HEVC参考软件也规定了正变换的相应比例因子(即$S_{T1}$, $S_{T2}$)。选择比例因子时有以下限制:

1. 所有比例因子应为2的幂，以允许将缩放实现为右移。
2. 假设输入残差块(例如，所有样本都具有最大幅度的DC块)的全范围，每个变换阶段之后的比特深度应该等于16比特(包括符号比特)。这被认为是准确性和实施成本之间的合理权衡。
3. 由于HEVC矩阵按$2^{6+M/2}$进行缩放，二维正向和反向变换的级联将导致1D行正向变换、1D列正向变换、1D列反向变换和1D行反向变换中的每一个按$2^{6+M/2}$进行缩放。因此，为了通过二维正变换和逆变换保持范数，所有比例因子的乘积应等于$\left(\dfrac{1}{2^{6+M/2}}\right)^4=2^{-24}2^{-2M}$。

图6.4中以4x4前向变换为例说明了选择前向变换比例因子的过程。当视频具有$B$比特的比特深度时，残差范围为$[-2^B+1, 2^B-1]$， 需要$B+1$比特来表示它。在下面的最坏情况比特深度分析中，我们将假设一个剩余块，所有样本的最大幅度等于$-2^B$，作为前向变换第一级的输入。我们认为这是一个合理的假设，因为所有的基向量几乎具有相同的范数。还要注意，在最坏的情况分析中，我们使用$-2^B$ 而不是$-2^B+1$ 或 $2^B-1$，因为它是2的幂。

![image-20210920112511909](/变换.assets/image-20210920112511909-1632108319683.png)

确定前向变换的中间比例因子，使中间值和输出值在16位以内。$B$是视频比特深度和$M=\log_2N$，其中$N$是变换大小。最坏情况比特深度分析是假设剩余块作为前向变换第一级的输入来完成的，其中所有样本的最大幅度等于$-2^B$(其中$B=8$是视频比特深度)。(a)正向变换的第一阶段，(b)正向变换的第二阶段。

假设输入为$-2^B$(仍在$B+1$位内),比例因子推导变得更简单，因为所有比例因子都是2的幂。对于这种最坏情况的输入块，输出样本的最大值将是$-2^B\times N\times 64$。这对应于第一基本向量(长度为n，所有值等于64)与由等于$-2^B$的值组成的输入向量的点积。因此，对于$N=2^M$，为了使输出适合16位(即$-2^{15}$的最大值)，需要$1/(2^B\times 2^M\times 2^6)$的比例。因此，第一变换阶段之后的比例因子被选择为$S_{T1}=2^{-B-M+9}$)。

正向变换的第二阶段包括将第一变换阶段的结果与D4相乘。正向变换第二级的输入是来自第一级的输出，第一级是一个矩阵，第一行中所有元素的2值为15。所有其他元素将为零，如图6.4所示。与D T 4相乘的输出将是一个矩阵，只有DC值等于2 15  2 M  2 6，所有剩余值等于0。这意味着，为了使输出适合16位，在变换的第二阶段之后所需的缩放是S T2 D 2 (M C 6。

逆变换的第一阶段包括将正向变换的结果与D4相乘。在我们的例子中，逆变换第一级的输入是来自前向变换的输出矩阵，该矩阵只有等于2 15的DC元素。与D4相乘的输出将是一个矩阵，其第一列元素等于2 15  2 6。因此，在逆变换的第一阶段之后，为使输出适合16位所需的定标是6。

逆变换的第二阶段由逆变换的第一阶段的结果与D 4相乘组成。逆变换第二级的输入是来自逆变换第一级的输出矩阵，它是第一列元素等于2 15的矩阵。与D 4相乘的输出将是一个矩阵，所有元素等于2 15  2 6。因此，在逆变换的第二阶段之后，将输出值带入[2 B，2 B 1]的原始范围所需的缩放比例是S IT2 D 2 (21 B。

